#!/bin/ash

# wdController v1.5

TEST=0
CHECK="rw"

ubus call system watchdog '{"magicclose": true}'
ubus call system watchdog '{"stop": true}'


while [ "$CHECK" != "ro" ] && [ $TEST = 0 ]; do

    CHECK=`cat /proc/mounts | grep /dev/sda1 | awk '{print substr($4,1,2)}'`

    lsblk -f --output NAME,TYPE,STATE | grep disk > /dev/null
    TEST=`echo $?`

    echo -n "X"

    sleep 3

done > /dev/watchdog


echo "Reboot after IO failure"
