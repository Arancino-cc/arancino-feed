#!/bin/sh /etc/rc.common
#
#              Apache License
#        Version 2.0, January 2004
#     http://www.apache.org/licenses/
#
#Copyright (c) 2017 Nicola Peditto


export PATH=/bin:/sbin:/usr/bin:/usr/sbin
export NODEJS=/usr/bin/node
export LD_LIBRARY_PATH=/usr/lib
export NPM=/usr/bin/npm
export NODE_PATH=/usr/lib/node_modules:/usr/lib/node_modules:$NODE_PATH
export NODE_TLS_REJECT_UNAUTHORIZED=0
export IOTRONIC_HOME=/var/lib/iotronic
export LIGHTNINGROD_HOME=/usr/lib/node_modules/@mdslab/iotronic-lightning-rod

START=99
STOP=99

boot () {

        #start
	    echo "LR booting..."
}

start () {

        pid=`ps aux | grep lightning-rod.js | grep -v grep | awk {'print $1'}`

        if [ -r $pid ]; then
		if [ -e $LIGHTNINGROD_HOME/lightning-rod.js ]; then
                	node $LIGHTNINGROD_HOME/lightning-rod.js >> /dev/null & # /var/log/iotronic/lightning-rod.log &
                	echo "Lightning-rod is started"
		else
			echo "Lightining-rod not installed"
		fi
        else
                echo "Lightning-rod is already started with PID $pid"
        fi

}

stop () {
        kill -9 `ps aux | grep wstun.js | grep -v grep | awk {'print $1'}` > /dev/null 2>&1
        echo "WSTUN processes stopped"
        kill -9 `ps aux | grep lightning-rod.js | grep -v grep | awk {'print $1'}` > /dev/null 2>&1
        echo "Lightning-rod is stopped"
}

restart () {

        stop
        start

}
